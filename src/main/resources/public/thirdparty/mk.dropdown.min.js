angular.module("mk.dropdown.tpl", []).run(["$templateCache", function (a) {
    a.put("templates/mk.dropdown.tpl.html", '' +
        '<div class="input-group"> ' +
        '<div id="buttonDiv" class="input-group-btn"> ' +
        '<input ng-change="toggleDropdown()" ng-keydown="moveFocus($event)" ng-blur="setItem()" type="text" class="form-control" ng-model="itemValue" aria-label="..."> ' +
        '<ul id="dropdownUl" class="dropdown-menu"> ' +
        '<li ng-repeat="location in items | filter:filterOnLocation" ng-keydown="onKeyDown($event, location)" ng-click="onMouseDown(location)">' +
        '<a href="" ng-blur="setItem()">{{location.title}}</a>' +
        '</li> ' +
        '</ul> ' +
        '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" ng-blur="setItem()">' +
        '<span class="caret"></span>' +
        '</button> ' +
        '</div> ' +
        '</div>')
}]), angular.module("mk.dropdown", ["mk.dropdown.tpl"]).directive("mkDropdown", function () {
    return {
        templateUrl: "templates/mk.dropdown.tpl.html",
        scope: {
            itemValue: "=?",
            items: "=",
            itemLabel: "@",
            itemId: "@?",
            item: "=?",
            ngChange: "&"
        },
        replace: true,
        controller: ["$scope", "$q", function ($scope, $q) {
            if (!$scope.itemId) {
                $scope.itemId = "id";
            }
            if (!$scope.model) {
                $scope.model = {};
            }
            $scope.onKeyDown = function (event, location) {
                if (event.which === 13) {
                    $scope.itemValue = angular.copy(location.title);
                }
            };

            $scope.onMouseDown = function (location) {
                $scope.itemValue = angular.copy(location.title);
            };

            $scope.toggleDropdown = function () {
                var element = angular.element(document.querySelector('#buttonDiv'));
                element.addClass("open");
            };

            $scope.setItem = function () {
                $scope.item = null;
                if ($scope.itemValue) {
                    $scope.items.forEach(function (it, index) {
                        if (it[$scope.itemLabel].toLowerCase() == $scope.itemValue.toLowerCase()) {
                            $scope.item = it;
                        }
                    });
                }
            }

            $scope.moveFocus = function (event) {
                $scope.toggleDropdown();
                if (event.which === 40) {
                    var element = angular.element(document.querySelector(' #dropdownUl'));
                    setTimeout(function () {
                        element.find("a:first").focus();
                    }, 100);
                }
            };
            $scope.filterOnLocation = function (location) {
                if ($scope.itemValue) {
                    var match = (location.title).toLowerCase().indexOf($scope.itemValue.toLowerCase()) >= 0;
                    return match;
                } else {
                    return true;
                }
            };

        }]
    }
});